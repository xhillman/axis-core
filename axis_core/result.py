"""Result types for axis-core agent execution.

Provides frozen dataclasses for run results, statistics, and stream events.
Per AD-036, RunResult is immutable with a copy() helper for transformations.
"""

from __future__ import annotations

import dataclasses
from dataclasses import dataclass
from datetime import datetime
from typing import Any

from axis_core.context import RunState
from axis_core.errors import AxisError
from axis_core.protocols.telemetry import TraceEvent


@dataclass(frozen=True)
class RunStats:
    """Aggregated statistics for a completed agent run.

    Attributes:
        cycles: Number of observe-plan-act-evaluate cycles completed
        tool_calls: Total tool invocations
        model_calls: Total LLM API calls
        input_tokens: Total input tokens sent to LLM
        output_tokens: Total output tokens generated by LLM
        total_tokens: Sum of input and output tokens
        cost_usd: Estimated total cost
        duration_ms: Wall-clock time in milliseconds
    """

    cycles: int
    tool_calls: int
    model_calls: int
    input_tokens: int
    output_tokens: int
    total_tokens: int
    cost_usd: float
    duration_ms: float


@dataclass(frozen=True)
class StreamEvent:
    """Event emitted during streaming agent execution.

    Attributes:
        type: Event type (e.g., "model_token", "run_completed", "tool_called")
        timestamp: When the event occurred
        data: Event-specific payload
        sequence: Optional ordering index within event type
    """

    type: str
    timestamp: datetime
    data: dict[str, Any]
    sequence: int | None = None

    @property
    def is_token(self) -> bool:
        """True if this is a model token event."""
        return self.type == "model_token"

    @property
    def token(self) -> str | None:
        """Extract token string from model_token events, None otherwise."""
        if self.type == "model_token":
            return self.data.get("token")
        return None

    @property
    def is_final(self) -> bool:
        """True if this is a terminal event (run_completed or run_failed)."""
        return self.type in ("run_completed", "run_failed")


@dataclass(frozen=True)
class RunResult:
    """Immutable result of an agent execution (AD-036).

    Frozen dataclass that captures all outputs, statistics, and state from
    a completed agent run. Use copy() to create modified copies.

    Attributes:
        output: Final output value (typed if output_schema was used)
        output_raw: Raw string output from the model
        success: True if completed without fatal error
        error: Error if success=False
        had_recoverable_errors: True if any non-fatal errors occurred
        stats: Aggregated run statistics
        trace: All telemetry events collected during run
        state: Full execution state (for debugging/replay)
        run_id: Unique run identifier for correlation
        memory_error: Error from memory persistence (non-fatal per AD-007)
    """

    output: Any
    output_raw: str
    success: bool
    error: AxisError | None
    had_recoverable_errors: bool
    stats: RunStats
    trace: list[TraceEvent]
    state: RunState
    run_id: str
    memory_error: AxisError | None = None

    def copy(self, **changes: Any) -> RunResult:
        """Create a copy with specified fields changed."""
        return dataclasses.replace(self, **changes)


__all__ = [
    "RunResult",
    "RunStats",
    "StreamEvent",
]
